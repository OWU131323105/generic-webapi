<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="quiz.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ITパスポート対策クイズ</h1>
        </div>

        <div class="quiz-container">
            <!-- クイズ設定画面 -->
            <div class="quiz-setup" id="quizSetup">
                <div class="form-group">
                    <label for="quizTitle">クイズのタイトル:</label>
                    <input type="text" id="quizTitle" placeholder="例: ITパスポート対策クイズ" value="ITパスポート対策クイズ">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="questionCount">問題数:</label>
                        <input type="number" id="questionCount" min="1" max="20" value="5">
                    </div>
                    
                    <div class="form-group">
                        <button class="btn" onclick="generateQuiz()">クイズを生成</button>
                    </div>
                </div>
            </div>

            <!-- クイズ実行画面 -->
            <div class="quiz-playing" id="quizPlaying">
                <div class="quiz-progress" id="quizProgress"></div>
                <h2 id="quizTitleDisplay"></h2>
                
                <div class="question" id="currentQuestion"></div>
                
                <ul class="selections" id="selections"></ul>
                
                <div class="answer-feedback" id="answerFeedback"></div>
                
                <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">次の問題</button>
                <button class="btn" id="finishBtn" onclick="showResults()" style="display: none;">結果を見る</button>
            </div>

            <!-- 結果画面 -->
            <div class="quiz-results" id="quizResults">
                <h2>クイズ結果</h2>
                <div class="score" id="finalScore"></div>
                <button class="btn" onclick="restartQuiz()">新しいクイズを作成</button>
            </div>
        </div>

        <div class="status" id="status">Ready</div>
        <div class="loading" id="loading">クイズを生成中...</div>
    </div>

    <script>
        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let hasAnswered = false;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
        });

        // ステータス更新
        function updateStatus() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Ready to generate ITパスポート quiz';
            statusEl.style.color = '#28a745';
        }

        // クイズ生成
        async function generateQuiz() {
            const title = document.getElementById('quizTitle').value.trim();
            const count = parseInt(document.getElementById('questionCount').value);

            if (!title || count < 1) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            document.getElementById('loading').classList.add('show');

            try {
                const response = await fetch('/api/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        count: count
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API error');
                }

                const data = await response.json();
                quizData = data.questions;

                if (!Array.isArray(quizData) || quizData.length === 0) {
                    throw new Error('Invalid quiz data format');
                }

                currentQuestionIndex = 0;
                score = 0;
                document.getElementById('quizTitleDisplay').textContent = data.title;
                startQuiz();
                
            } catch (error) {
                console.error('Error:', error);
                alert('クイズの生成に失敗しました: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        // クイズ開始
        function startQuiz() {
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizPlaying').style.display = 'block';
            document.getElementById('quizResults').style.display = 'none';
            showQuestion();
        }

        // 問題表示
        function showQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                showResults();
                return;
            }

            const question = quizData[currentQuestionIndex];
            hasAnswered = false;
            selectedAnswer = null;

            document.getElementById('quizProgress').textContent = 
                `問題 ${currentQuestionIndex + 1} / ${quizData.length}`;
            
            document.getElementById('currentQuestion').textContent = question.question;
            
            const selectionsEl = document.getElementById('selections');
            selectionsEl.innerHTML = '';
            
            question.selections.forEach((selection, index) => {
                const li = document.createElement('li');
                li.className = 'selection-item';
                li.textContent = selection;
                li.onclick = () => selectAnswer(index);
                selectionsEl.appendChild(li);
            });

            document.getElementById('answerFeedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
        }

        // 答え選択
        function selectAnswer(index) {
            if (hasAnswered) return;

            selectedAnswer = index;
            hasAnswered = true;

            const question = quizData[currentQuestionIndex];
            const correctAnswer = question.answer;
            const isCorrect = selectedAnswer === correctAnswer;

            if (isCorrect) {
                score++;
            }

            const selectionItems = document.querySelectorAll('.selection-item');
            selectionItems.forEach((item, i) => {
                item.onclick = null;
                if (i === correctAnswer) {
                    item.classList.add('correct');
                } else if (i === selectedAnswer && !isCorrect) {
                    item.classList.add('incorrect');
                }
            });

            const feedback = document.getElementById('answerFeedback');
            feedback.style.display = 'block';
            if (isCorrect) {
                feedback.className = 'answer-feedback correct';
                feedback.textContent = '正解！';
            } else {
                feedback.className = 'answer-feedback incorrect';
                feedback.textContent = `不正解。正解は「${question.selections[correctAnswer]}」です。`;
            }

            if (currentQuestionIndex < quizData.length - 1) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                document.getElementById('finishBtn').style.display = 'inline-block';
            }
        }

        // 次の問題
        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        // 結果表示
        function showResults() {
            document.getElementById('quizPlaying').style.display = 'none';
            document.getElementById('quizResults').style.display = 'block';
            
            const percentage = Math.round((score / quizData.length) * 100);
            document.getElementById('finalScore').textContent = 
                `${score} / ${quizData.length} 問正解 (${percentage}%)`;
        }

        // クイズリスタート
        function restartQuiz() {
            document.getElementById('quizResults').style.display = 'none';
            document.getElementById('quizSetup').style.display = 'block';
            quizData = [];
            currentQuestionIndex = 0;
            score = 0;
        }
    </script>
</body>
</html>