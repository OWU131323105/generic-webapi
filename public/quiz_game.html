<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸˆ AIæ—©æŠ¼ã—ã‚¯ã‚¤ã‚ºå¤§ä¼š (æœ€å¤§5äºº) ğŸˆ</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.8.0/p5.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: sans-serif;
      background-color: #f0f0f0;
    }

    h1 { color: #333; margin: 10px 0; font-size: 1.5rem; }

    #game-container {
      position: relative;
    }

    canvas {
      border: 5px solid #6c3b1c;
      background-color: #fff6f0; 
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: block;
    }

    /* ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #score-container {
      width: 800px;
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      margin-top: 10px;
      padding: 0 10px;
      box-sizing: border-box;
      flex-wrap: wrap;
    }

    .player-score {
      background: white;
      padding: 5px 15px;
      border-radius: 15px;
      font-weight: bold;
      font-size: 1.2rem;
      border: 3px solid #ccc;
      min-width: 100px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #status-display {
      margin-top: 5px;
      color: #555;
      font-weight: bold;
    }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #start-menu {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      width: 320px;
      display: none;
    }
    #start-menu h2 { margin-top: 0; color: #333; font-size: 1.2rem; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    .input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem;}
    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #connect-info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }
    #myid { font-weight: bold; color: red; }
  </style>
</head>

<body>
  <h1>ğŸˆ AIæ—©æŠ¼ã—ã‚¯ã‚¤ã‚ºå¤§ä¼š ğŸˆ</h1>

  <div id="game-container">
    <div id="start-menu">
      <h2>ã‚¯ã‚¤ã‚ºè¨­å®š</h2>
      <div class="input-group">
        <label for="theme-input">ã‚¯ã‚¤ã‚ºã®ãƒ†ãƒ¼ãƒ</label>
        <input type="text" id="theme-input" value="ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ" placeholder="ä¾‹: æ—¥æœ¬å², ãƒã‚±ãƒ¢ãƒ³">
      </div>
      <div class="input-group">
        <label for="count-input">å•é¡Œæ•°</label>
        <select id="count-input">
          <option value="3">3å•</option>
          <option value="5">5å•</option>
          <option value="10">10å•</option>
        </select>
      </div>
      <p style="color: #d32f2f; font-weight: bold; font-size: 20px;">
        ã‚¹ãƒãƒ›ã‚’æŒ¯ã£ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼
      </p>
      <div id="connect-info">
        ã‚¹ãƒãƒ›ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’é–‹ã„ã¦ãã ã•ã„<br>
        ID: <span id="myid">---</span>
      </div>
    </div>
  </div>

  <div id="score-container">
    <div style="color:#888;">å‚åŠ è€…å¾…æ©Ÿä¸­...</div>
  </div>
  <div id="status-display"></div>

  <script>
    const socket = io();

    let myid = sessionStorage.getItem('clientId');
    if (!myid) {
      myid = Math.random().toString(36).substring(2, 6).toUpperCase();
      sessionStorage.setItem('clientId', myid);
    }
    document.getElementById("myid").innerText = myid;

    socket.emit("join", "game");

    // ===== è¤‡æ•°äººç®¡ç†ç”¨ã®å¤‰æ•° =====
    const MAX_PLAYERS = 5;
    const PLAYER_COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#9B59B6'];
    let players = {};
    let playerOrder = [];

    // --- Socketã‚¤ãƒ™ãƒ³ãƒˆ ---
    socket.on("sensor", data => {
      const pid = data.id;
      if (!pid) return;

      if (!players[pid]) {
        addPlayer(pid);
      }
      if (players[pid]) {
        players[pid].gamma = parseFloat(data.g);
      }
    });

    socket.on("smash", data => {
      const pid = data.id;
      if (players[pid]) {
        handleSmash(pid);
      }
    });

    socket.on("player_left", data => {
      console.log("Player left:", data.id);
    });

    function addPlayer(id) {
      if (playerOrder.length >= MAX_PLAYERS) return;
      if (playerOrder.includes(id)) return;

      const pIndex = playerOrder.length;
      playerOrder.push(id);

      players[id] = {
        id: id,
        index: pIndex,
        name: `P${pIndex + 1}`,
        color: PLAYER_COLORS[pIndex],
        score: 0,
        gamma: 0,
        cursorX: CANVAS_WIDTH / 2,
        isSmashing: false,
        smashTimer: null
      };

      updateScoreBoard();
    }

    function updateScoreBoard() {
      const container = document.getElementById('score-container');
      container.innerHTML = '';

      if (playerOrder.length === 0) {
        container.innerHTML = '<div style="color:#888;">å‚åŠ è€…å¾…æ©Ÿä¸­...</div>';
        return;
      }

      playerOrder.forEach(id => {
        const p = players[id];
        const div = document.createElement('div');
        div.className = 'player-score';
        div.style.borderColor = p.color;
        div.style.color = p.color;
        div.innerHTML = `${p.name}: <span style="color:#333">${p.score}</span>`;
        container.appendChild(div);
      });
    }

    // ===== ã‚²ãƒ¼ãƒ å®šæ•°ãƒ»å¤‰æ•° =====
    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 600;
    const NUM_OPTIONS = 4;
    
    let targetPositions = [];
    const TARGET_Y = 450;
    const TARGET_SIZE = 80;
    const CURSOR_SIZE = 100;

    let img_cathand_1, img_cathand_2;
    
    const STATE = {
      START: 'START',
      LOADING: 'LOADING',
      QUESTION: 'QUESTION',
      RESULT: 'RESULT',
      GAMEOVER: 'GAMEOVER'
    };
    let gameState = STATE.START;

    let quizList = [];
    let currentQuestionIndex = 0;
    let resultMessage = "";
    let resultColor = "";
    
    const ICON_COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];

    // ç”»åƒã‚¢ã‚»ãƒƒãƒˆç®¡ç†ç”¨é…åˆ—
    let handImages = []; // ã“ã“ã«5äººåˆ†ã®ç”»åƒã‚»ãƒƒãƒˆãŒå…¥ã‚Šã¾ã™

    // èª­ã¿è¾¼ã‚€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®è¨­å®š
    // â€»å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„
    const HAND_FILES = [
      { up: 'images/cathand_1.png', down: 'images/cathand_2.png' }, // 1äººç›®
      { up: 'images/cathand1_1.png', down: 'images/cathand1_2.png' }, // 2äººç›®
      { up: 'images/cathand2_1.png', down: 'images/cathand2_2.png' }, // 3äººç›®
      { up: 'images/cathand3_1.png', down: 'images/cathand3_2.png' }, // 4äººç›®
      { up: 'images/cathand4_1.png', down: 'images/cathand4_2.png' }  // 5äººç›®
    ];

    function preload() {

      // 5äººåˆ†ã®ç”»åƒã‚’ãƒ«ãƒ¼ãƒ—ã§èª­ã¿è¾¼ã¿
      for (let i = 0; i < HAND_FILES.length; i++) {
        handImages.push({
          up: loadImage(HAND_FILES[i].up),
          down: loadImage(HAND_FILES[i].down)
        });
      }
      
      // â€»ã‚‚ã—ç”»åƒãŒè¶³ã‚Šãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿ç”¨ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚‚èª­ã¿è¾¼ã‚“ã§ãŠãã¨å®‰å…¨ã§ã™
      // img_cathand_1 = loadImage('cathand_1.PNG');
    }

    function setup() {
      let cnv = createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
      cnv.parent('game-container'); 

      textSize(20);
      textAlign(CENTER, CENTER);
      imageMode(CENTER);

      const spacing = width / (NUM_OPTIONS + 1);
      for (let i = 0; i < NUM_OPTIONS; i++) {
        targetPositions.push(spacing * (i + 1));
      }

      document.getElementById('start-menu').style.display = 'block';
    }

    async function fetchQuiz() {
      const themeVal = document.getElementById('theme-input').value || "ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ";
      const countVal = document.getElementById('count-input').value;

      document.getElementById('start-menu').style.display = 'none';
      gameState = STATE.LOADING;
      
      try {
        const response = await fetch('/api/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ theme: themeVal, count: countVal })
        });

        const json = await response.json();

        if (json.error) {
           alert("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:\n" + json.error);
           resetToTitle();
           return;
        }

        if (json.data && Array.isArray(json.data)) {
           quizList = json.data;
           currentQuestionIndex = 0;
           
           playerOrder.forEach(id => players[id].score = 0);
           updateScoreBoard();
           
           gameState = STATE.QUESTION;
           document.getElementById('status-display').innerText = "";
        } else {
           alert("AIãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼");
           resetToTitle();
        }

      } catch (e) {
        console.error(e);
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message);
        resetToTitle();
      }
    }

    function resetToTitle() {
      gameState = STATE.START;
      document.getElementById('start-menu').style.display = 'block';
      document.getElementById('status-display').innerText = "";
    }

    function handleSmash(pid) {
      const p = players[pid];
      if (!p) return;

      p.isSmashing = true;
      if (p.smashTimer) clearTimeout(p.smashTimer);
      p.smashTimer = setTimeout(() => p.isSmashing = false, 150);

      if (gameState === STATE.START) {
        fetchQuiz();
        return;
      }

      if (gameState === STATE.GAMEOVER) {
        resetToTitle();
        return;
      }

      if (gameState !== STATE.QUESTION) return;

      let hitIndex = -1;
      for (let i = 0; i < NUM_OPTIONS; i++) {
        let d = dist(p.cursorX, TARGET_Y, targetPositions[i], TARGET_Y);
        if (d < TARGET_SIZE) {
          hitIndex = i;
          break;
        }
      }

      if (hitIndex !== -1) {
        checkAnswer(pid, hitIndex);
      }
    }

    function checkAnswer(pid, userIndex) {
      const q = quizList[currentQuestionIndex];
      const p = players[pid];
      
      if (userIndex === q.answerIndex) {
        p.score += 10;
        updateScoreBoard();
        resultMessage = `${p.name} æ­£è§£ï¼â­•ï¸`;
        resultColor = "#00ff00";
      } else {
        resultMessage = `${p.name} ä¸æ­£è§£...âŒ`;
        resultColor = "#ff0000";
      }

      gameState = STATE.RESULT;
      
      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex >= quizList.length) {
          gameState = STATE.GAMEOVER;
        } else {
          gameState = STATE.QUESTION;
        }
      }, 2000);
    }

    function draw() {
      clear();

      playerOrder.forEach(id => {
        const p = players[id];
        p.cursorX = map(p.gamma, -30, 30, 0, width, true);
        p.cursorX = constrain(p.cursorX, 0, width);
      });

      if (gameState === STATE.START) {
        fill(255, 255, 255, 100);
        rect(0, 0, width, height);
      } 
      else if (gameState === STATE.GAMEOVER) {
        fill(0, 0, 0, 150);
        rect(0, 0, width, height);
        
        // â–¼â–¼â–¼ åŒç‚¹å„ªå‹å¯¾å¿œãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
        
        // 1. æœ€é«˜å¾—ç‚¹ã‚’æ¢ã™
        let maxScore = -1;
        playerOrder.forEach(id => {
            if (players[id].score > maxScore) {
                maxScore = players[id].score;
            }
        });

        // 2. æœ€é«˜å¾—ç‚¹ã®äººã‚’å…¨å“¡ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
        let winners = [];
        playerOrder.forEach(id => {
            if (players[id].score === maxScore) {
                winners.push(players[id].name);
            }
        });

        // 3. è¡¨ç¤º
        fill(255);
        textSize(50);
        if (winners.length > 0) {
            // "å„ªå‹: P1, P2 (30ç‚¹)"
            text(`å„ªå‹: ${winners.join(", ")} (${maxScore}ç‚¹)`, width/2, height/2 - 50);
        } else {
            text("ã‚²ãƒ¼ãƒ çµ‚äº†", width/2, height/2 - 50);
        }
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        textSize(30);
        text("ã‚¹ãƒãƒ›ã‚’æŒ¯ã£ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸", width/2, height/2 + 50);
      }
      else if (gameState === STATE.LOADING) {
        fill(0);
        textSize(30);
        text("AIãŒå•é¡Œã‚’ç”Ÿæˆä¸­...ğŸŸ", width/2, height/2);
      }
      else if (gameState === STATE.QUESTION || gameState === STATE.RESULT) {
        drawQuizScreen();
      }

// --- å…¨å“¡ã®ãƒã‚³ã®æ‰‹ã‚’æç”» ---
      playerOrder.forEach(id => {
        const p = players[id];
        const hammerY = TARGET_Y + 65;
        
        /*// è­˜åˆ¥ç”¨ã®å††ã¨åå‰ã‚’æç”»
        fill(p.color);
        noStroke();
        ellipse(p.cursorX, hammerY - 20, 30, 30);
        fill(255);
        textSize(14);
        textAlign(CENTER, CENTER);
        text(p.name, p.cursorX, hammerY - 20);*/

        // â˜…ã“ã“ã‚’å¤‰æ›´: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·ã«å¯¾å¿œã—ãŸç”»åƒã‚’ä½¿ã†
        // ç”»åƒé…åˆ—ã®ç¯„å›²å¤–ã«ãªã‚‰ãªã„ã‚ˆã† % ã§å®‰å…¨ç­–ã‚’ã¨ã‚‹
        const imgSet = handImages[p.index % handImages.length];

        if (p.isSmashing) {
          // å©ã„ã¦ã„ã‚‹ç”»åƒ
          image(imgSet.down, p.cursorX, hammerY + 20, CURSOR_SIZE, CURSOR_SIZE);
        } else {
          // é€šå¸¸ã®ç”»åƒ
          image(imgSet.up, p.cursorX, hammerY, CURSOR_SIZE, CURSOR_SIZE);
        }
      });
    }

    function drawQuizScreen() {
      const q = quizList[currentQuestionIndex];

      fill(50);
      noStroke();
      textSize(24);
      textAlign(LEFT, TOP);
      textWrap(CHAR);
      text(`Q${currentQuestionIndex + 1}. ${q.question}`, 60, 50, width - 120, 220);

      textSize(20);
      const startY = 150;
      const lineHeight = 45;

      for (let i = 0; i < NUM_OPTIONS; i++) {
        const y = startY + (i * lineHeight);
        fill(ICON_COLORS[i]); textStyle(BOLD);
        text(String.fromCharCode(65 + i) + ".", 50, y);
        fill(0); textStyle(NORMAL);
        text(q.options[i], 90, y, width - 140);
      }

      textAlign(CENTER, CENTER);
      for (let i = 0; i < NUM_OPTIONS; i++) {
        const x = targetPositions[i];
        fill(ICON_COLORS[i]); stroke(255); strokeWeight(3);
        ellipse(x, TARGET_Y, TARGET_SIZE, TARGET_SIZE);
        fill(255); noStroke(); textSize(40); textStyle(BOLD);
        text(String.fromCharCode(65 + i), x, TARGET_Y + 2);
      }
      textStyle(NORMAL); 

      if (gameState === STATE.RESULT) {
        fill(0, 0, 0, 150);
        rectMode(CORNER);
        rect(0, 0, width, height);
        
        fill(resultColor);
        textSize(80);
        textAlign(CENTER, CENTER);
        text(resultMessage, width/2, height/2);
        
        fill(255);
        textSize(30);
        text(`æ­£è§£ã¯: ${String.fromCharCode(65 + q.answerIndex)}`, width/2, height/2 + 80);
      }
    }
  </script>
</body>
</html>